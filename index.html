<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PCI Pal Wrapper</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline';
                 style-src  'self' 'unsafe-inline';
                 frame-src  https://euwest1.pcipalstaging.cloud;">

  <style>
    html, body { margin: 0; height: 100%; }
    #debug {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 8px 10px;
      font: 12px/1.4 Arial, sans-serif;
      background: rgba(0,0,0,0.75);
      color: #fff;
      z-index: 999999;
      word-break: break-word;
    }
    #frameWrap {
      height: 100%;
      padding-top: 34px;
      box-sizing: border-box;
    }
    iframe { width: 100%; height: 100%; border: 0; }
  </style>
</head>

<body>
  <div id="debug">Wrapper initialisingâ€¦</div>

  <form id="pciForm" method="post" target="pciIframe">
    <input type="hidden" name="x-bearer-token"  id="bt">
    <input type="hidden" name="x-refresh-token" id="rt">
  </form>

  <div id="frameWrap">
    <iframe name="pciIframe" id="pciIframe"></iframe>
  </div>

  <script>
    // ----------------------------
    // Debug logger (console + on-screen)
    // ----------------------------
    const debugEl = document.getElementById('debug');
    const WRAPPER_INSTANCE_ID = Math.random().toString(16).slice(2);

    function log(msg, extra) {
      const ts = new Date().toISOString();
      const line = `[${ts}] [${WRAPPER_INSTANCE_ID}] ${msg}` + (extra ? ` ${extra}` : '');
      console.log(line);
      debugEl.textContent = line;
    }

    // ----------------------------
    // Lifecycle instrumentation
    // ----------------------------
    log('WRAPPER_LOADED', `origin=${window.location.origin} href=${window.location.href}`);

    window.addEventListener('pagehide', () => log('WRAPPER_PAGEHIDE'));
    window.addEventListener('beforeunload', () => log('WRAPPER_BEFOREUNLOAD'));

    document.addEventListener('visibilitychange', () => {
      log('WRAPPER_VISIBILITY', `state=${document.visibilityState}`);
    });

    window.addEventListener('blur', () => log('WRAPPER_BLUR'));
    window.addEventListener('focus', () => log('WRAPPER_FOCUS'));

    window.addEventListener('error', (e) => {
      log('WRAPPER_WINDOW_ERROR', `${e.message || e.type}`);
    });

    window.addEventListener('unhandledrejection', (e) => {
      const reason = (e && e.reason && (e.reason.message || String(e.reason))) || 'unknown';
      log('WRAPPER_UNHANDLED_REJECTION', reason);
    });

    // ----------------------------
    // PCI Pal iframe load/reload logging (added)
    // ----------------------------
    const pciIframe = document.getElementById('pciIframe');

    pciIframe.addEventListener('load', () => {
      // We can't always read href due to cross-origin, so handle gracefully
      let href = '(unknown)';
      try {
        href = pciIframe.contentWindow.location.href;
      } catch (e) {
        href = '(cross-origin - cannot read href)';
      }
      log('PCI_IFRAME_LOAD', `href=${href}`);
    });

    // ----------------------------
    // Existing behaviour: load PCI Pal from query params
    // ----------------------------
    (function () {
      const qs = new URLSearchParams(window.location.search);
      const sid = qs.get('sid');
      const bt  = qs.get('bt');
      const rt  = qs.get('rt');

      if (!sid || !bt || !rt) {
        log('MISSING_QUERY_PARAMS', 'Need sid, bt, rt in URL');
        document.body.innerHTML =
          '<div style="padding:12px;font-family:Arial;">Missing sid, bt, or rt parameters.</div>';
        return;
      }

      log('QUERY_PARAMS_PRESENT', `sid=${sid}`);

      const form = document.getElementById('pciForm');
      form.action =
        'https://genesys-service.pcipal.cloud/purecloud/v3/widget.html?pcConversationId={{Conversation ID}}&pcEnvironment=mypurecloud.ie&writeSessionId=true&authDataAction=custom_-_59d53244-2622-4ae5-9383-b5dd7b41ad24&sessionDataAction=custom_-_6dd710d8-0b69-442e-bfda-d1efaac8e9b6&tenantId=1201&environment=pcipalstaging.cloud&region=euwest1' +
        encodeURIComponent(sid) +
        '/framed';

      document.getElementById('bt').value = bt;
      document.getElementById('rt').value = rt;

      log('SUBMITTING_TO_PCIPAL', form.action);
      form.submit();
    })();
  </script>
</body>
</html>

